<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CookLook - Scan Your Fridge, Cook Great Meals</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" href="/CookLook/icon-192.png">
    <link rel="manifest" href="/CookLook/manifest.json">
    <meta name="theme-color" content="#f9b234">
    
    <!-- iOS PWA support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="CookLook">
    <link rel="apple-touch-icon" href="/CookLook/icon-512.png">
</head>
<body>
    <!-- Hero Section -->
    <section class="hero">
        <div class="hero-content">
            <img src="IMG_0460.jpg" alt="CookLook Logo" class="logo">
            <h1>CookLook</h1>
            <p>Scan your food. Cook a great meal.</p>
            <p class="hero-subtitle">Take a photo of your ingredients and get personalized recipes instantly!</p>
            
            <!-- Camera Interface -->
            <div class="camera-container" id="cameraContainer" style="display: none;">
                <video id="camera" autoplay></video>
                <div class="camera-overlay">
                    <div class="scan-frame"></div>
                </div>
                <div class="camera-controls">
                    <button id="captureBtn" class="scan-btn">ğŸ“¸ Scan Ingredients</button>
                    <button id="closeBtn" class="close-btn">âœ•</button>
                </div>
            </div>
            
            <!-- Upload Button for Mobile -->
            <input type="file" id="uploadBtnMobile" accept="image/*" capture="environment" style="display: none;">
            
            <!-- Main Action Buttons -->
            <div class="action-buttons">
                <button id="scanBtn" class="scan-btn">ğŸ“· Scan Your Fridge</button>
                <button id="uploadBtn" class="upload-btn">ğŸ“ Upload Photo</button>
            </div>
            
            <!-- Mobile Tips -->
            <div class="mobile-tips" id="mobileTips" style="display: none;">
                <p>ğŸ’¡ <strong>Mobile Tips:</strong></p>
                <p>â€¢ Make sure you're using HTTPS (not HTTP)</p>
                <p>â€¢ Grant camera permission when prompted</p>
                <p>â€¢ Try the "Upload Photo" button if camera doesn't work</p>
            </div>
        </div>
    </section>

    <!-- Loading Section -->
    <section id="loading" class="loading-section" style="display: none;">
        <div class="spinner"></div>
        <h2>Analyzing your ingredients...</h2>
        <p>Our AI is identifying what's in your fridge</p>
    </section>

    <!-- Results Section -->
    <section id="results" class="results-section" style="display: none;">
        <h2>ğŸ½ï¸ Here's what we found:</h2>
        <div id="ingredientsList" class="ingredients-detected"></div>
        <div id="recipesContainer" class="recipes-container"></div>
        <button id="scanAgainBtn" class="scan-btn">ğŸ”„ Scan Again</button>
    </section>

    <script>
        // âœ… API Keys - Load from config
        let HF_API_KEY = "";
        let SPOON_KEY = "d774b10f22674128a2db72604dd1d5ed";
        
        // Load API keys from config file
        async function loadConfig() {
          try {
            const response = await fetch('config.json');
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }
            const config = await response.json();
            HF_API_KEY = config.HF_API_KEY || "";
            SPOON_KEY = config.SPOON_KEY || SPOON_KEY;
            console.log("âœ… Config loaded successfully");
          } catch (err) {
            console.warn("âš ï¸ Config file not found, using demo mode");
          }
        }
        
        // Initialize config
        loadConfig();

        // âœ… Elements
        const scanBtn = document.getElementById('scanBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadBtnMobile = document.getElementById('uploadBtnMobile');
        const cameraContainer = document.getElementById('cameraContainer');
        const camera = document.getElementById('camera');
        const captureBtn = document.getElementById('captureBtn');
        const closeBtn = document.getElementById('closeBtn');
        const loadingSection = document.getElementById('loading');
        const resultsSection = document.getElementById('results');
        const scanAgainBtn = document.getElementById('scanAgainBtn');
        const mobileTips = document.getElementById('mobileTips');

        // âœ… Check if HTTPS (required for camera on mobile)
        function checkHTTPS() {
          if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            mobileTips.style.display = 'block';
            return false;
          }
          return true;
        }

        // âœ… Start camera
        async function startCamera() {
          try {
            if (!checkHTTPS()) {
              alert("âš ï¸ Camera requires HTTPS. Please use the 'Upload Photo' button instead.");
              return;
            }

            const stream = await navigator.mediaDevices.getUserMedia({
              video: { 
                facingMode: 'environment',
                width: { ideal: 1280 },
                height: { ideal: 720 }
              }
            });
            
            camera.srcObject = stream;
            cameraContainer.style.display = 'block';
            document.body.style.overflow = 'hidden';
            
          } catch (err) {
            console.error('Camera error:', err);
            if (err.name === 'NotAllowedError') {
              alert("ğŸ“· Camera access denied. Please allow camera access and try again, or use the 'Upload Photo' button.");
            } else if (err.name === 'NotFoundError') {
              alert("ğŸ“· No camera found. Please use the 'Upload Photo' button instead.");
            } else {
              alert("ğŸ“· Camera error: " + err.message + "\n\nPlease try the 'Upload Photo' button instead.");
            }
          }
        }

        // âœ… Capture photo
        function capturePhoto() {
          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d');
          
          canvas.width = camera.videoWidth;
          canvas.height = camera.videoHeight;
          context.drawImage(camera, 0, 0);
          
          canvas.toBlob((blob) => {
            const file = new File([blob], 'captured-photo.jpg', { type: 'image/jpeg' });
            processImage(file);
          }, 'image/jpeg', 0.8);
          
          closeCamera();
        }

        // âœ… Close camera
        function closeCamera() {
          if (camera.srcObject) {
            camera.srcObject.getTracks().forEach(track => track.stop());
            camera.srcObject = null;
          }
          cameraContainer.style.display = 'none';
          document.body.style.overflow = 'auto';
        }

        // âœ… Process image
        function processImage(file) {
          console.log("ğŸ“¸ Processing image:", file.name);
          
          // Show loading
          loadingSection.style.display = 'block';
          resultsSection.style.display = 'none';
          
          // Analyze image
          analyzeImage(file);
        }

        // âœ… Analyze image - ENHANCED for better accuracy
        async function analyzeImage(file) {
          console.log("ğŸ” Enhanced image analysis...");
          
          try {
            // Load config
            await loadConfig();
            
            // Check API key
            if (!HF_API_KEY || HF_API_KEY === "") {
              console.log("âš ï¸ No API key, using fallback detection");
              const fallbackIngredients = ["potato", "carrot", "onion"];
              showDetectedIngredients(fallbackIngredients);
              await getRecipes(fallbackIngredients);
              return;
            }

            // Convert image to base64
            const base64Image = await new Promise((resolve) => {
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result.split(',')[1]);
              reader.readAsDataURL(file);
            });

            // Enhanced ingredient mapping for better accuracy
            const ingredientMap = {
              // Vegetables
              'broccoli': ['broccoli', 'broccoli florets', 'fresh broccoli', 'broccoli head'],
              'cauliflower': ['cauliflower', 'cauliflower head', 'cauliflower florets', 'white cauliflower'],
              'carrot': ['carrot', 'carrots', 'fresh carrot', 'orange carrot'],
              'potato': ['potato', 'potatoes', 'russet potato', 'red potato', 'white potato'],
              'tomato': ['tomato', 'tomatoes', 'cherry tomato', 'roma tomato', 'beefsteak tomato'],
              'onion': ['onion', 'onions', 'yellow onion', 'red onion', 'white onion'],
              'bell pepper': ['bell pepper', 'pepper', 'red pepper', 'green pepper', 'yellow pepper'],
              'cucumber': ['cucumber', 'cucumbers', 'english cucumber', 'persian cucumber'],
              'lettuce': ['lettuce', 'leafy greens', 'romaine lettuce', 'iceberg lettuce'],
              'spinach': ['spinach', 'fresh spinach', 'baby spinach', 'leafy greens'],
              'mushroom': ['mushroom', 'mushrooms', 'button mushroom', 'cremini mushroom'],
              'zucchini': ['zucchini', 'courgette', 'summer squash', 'green squash'],
              'eggplant': ['eggplant', 'aubergine', 'purple eggplant'],
              'cabbage': ['cabbage', 'green cabbage', 'white cabbage', 'napa cabbage'],
              'celery': ['celery', 'celery stalks', 'fresh celery'],
              'corn': ['corn', 'sweet corn', 'corn kernels', 'maize'],
              'peas': ['peas', 'green peas', 'sweet peas', 'garden peas'],
              'green beans': ['green beans', 'string beans', 'snap beans', 'haricot verts'],
              'asparagus': ['asparagus', 'fresh asparagus', 'green asparagus'],
              'beet': ['beet', 'beets', 'beetroot', 'red beet'],
              'radish': ['radish', 'radishes', 'red radish', 'daikon'],
              'turnip': ['turnip', 'turnips', 'white turnip'],
              'sweet potato': ['sweet potato', 'yam', 'sweet potatoes', 'orange sweet potato'],
              
              // Fruits
              'apple': ['apple', 'apples', 'red apple', 'green apple', 'gala apple'],
              'banana': ['banana', 'bananas', 'yellow banana'],
              'orange': ['orange', 'oranges', 'navel orange', 'valencia orange'],
              'lemon': ['lemon', 'lemons', 'fresh lemon', 'yellow lemon'],
              'lime': ['lime', 'limes', 'fresh lime', 'green lime'],
              'strawberry': ['strawberry', 'strawberries', 'red strawberry'],
              'blueberry': ['blueberry', 'blueberries', 'fresh blueberries'],
              'grape': ['grape', 'grapes', 'green grapes', 'red grapes'],
              'peach': ['peach', 'peaches', 'fresh peach'],
              'pear': ['pear', 'pears', 'green pear', 'bosc pear'],
              'cherry': ['cherry', 'cherries', 'red cherry'],
              'pineapple': ['pineapple', 'pineapples', 'fresh pineapple'],
              'mango': ['mango', 'mangoes', 'ripe mango'],
              'avocado': ['avocado', 'avocados', 'ripe avocado', 'hass avocado'],
              'kiwi': ['kiwi', 'kiwis', 'kiwi fruit', 'green kiwi'],
              'watermelon': ['watermelon', 'fresh watermelon'],
              'cantaloupe': ['cantaloupe', 'melon', 'muskmelon'],
              'honeydew': ['honeydew', 'honeydew melon'],
              'pomegranate': ['pomegranate', 'pomegranates', 'red pomegranate'],
              'coconut': ['coconut', 'coconuts', 'coconut meat', 'fresh coconut']
            };

            // Try multiple AI models for better accuracy
            const models = [
              'keremberke/food-image-classification',
              'google/vit-base-patch16-224',
              'microsoft/beit-base-patch16-224'
            ];
            
            let bestResults = [];
            let bestScore = 0;
            
            for (const model of models) {
              try {
                const response = await fetch(
                  `https://api-inference.huggingface.co/models/${model}`,
                  {
                    method: "POST",
                    headers: {
                      "Authorization": `Bearer ${HF_API_KEY}`,
                      "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ inputs: base64Image })
                  }
                );

                if (response.ok) {
                  const result = await response.json();
                  console.log(`ğŸ¤– ${model} Result:`, result);
                  
                  // Find the best scoring result
                  const topResult = result[0];
                  if (topResult && topResult.score > bestScore) {
                    bestResults = result;
                    bestScore = topResult.score;
                  }
                }
              } catch (err) {
                console.log(`âš ï¸ Model ${model} failed, trying next...`);
              }
            }

            if (bestResults.length === 0) {
              console.log("âŒ All models failed, using fallback detection");
              const fallbackIngredients = ["potato", "carrot", "onion"];
              showDetectedIngredients(fallbackIngredients);
              await getRecipes(fallbackIngredients);
              return;
            }

            console.log("ğŸ½ï¸ Best AI Result:", bestResults);

            // Enhanced ingredient extraction with mapping
            const rawIngredients = bestResults
              .filter(item => item.score > 0.2) // Lower threshold for more ingredients
              .slice(0, 5) // Get top 5 most confident results
              .map(item => item.label.toLowerCase());

            // Map raw results to proper ingredient names
            const mappedIngredients = rawIngredients.map(rawIngredient => {
              // Find best match in ingredient map
              for (const [key, variations] of Object.entries(ingredientMap)) {
                if (variations.some(variation => 
                  rawIngredient.includes(variation) || 
                  variation.includes(rawIngredient) ||
                  rawIngredient.includes(key) ||
                  key.includes(rawIngredient)
                )) {
                  return key;
                }
              }
              return rawIngredient; // Return original if no mapping found
            })
            .filter((ingredient, index, arr) => arr.indexOf(ingredient) === index) // Remove duplicates
            .slice(0, 4); // Limit to 4 ingredients

            console.log("ğŸ” Enhanced detected ingredients:", mappedIngredients);

            if (mappedIngredients.length === 0) {
              console.log("âš ï¸ No ingredients detected, using fallback");
              const fallbackIngredients = ["potato", "carrot", "onion"];
              showDetectedIngredients(fallbackIngredients);
              await getRecipes(fallbackIngredients);
              return;
            }

            // Show detected ingredients
            showDetectedIngredients(mappedIngredients);
            await getRecipes(mappedIngredients);

          } catch (err) {
            console.log("âŒ Error analyzing image, using fallback:", err);
            // Always show something
            const fallbackIngredients = ["potato", "carrot", "onion"];
            showDetectedIngredients(fallbackIngredients);
            await getRecipes(fallbackIngredients);
          }
        }

        // âœ… Fetch recipes from Spoonacular - ENHANCED with diverse cuisines
        async function getRecipes(ingredients) {
          console.log("ğŸ” Searching for diverse cuisine recipes with ingredients:", ingredients);
          
          // Create diverse fallback recipes for different cuisines
          const fallbackRecipes = [
            {
              id: 'fallback-american-1',
              title: `American ${ingredients.join(' and ')} Stir-Fry`,
              readyInMinutes: 25,
              servings: 2,
              usedIngredients: ingredients.map(ing => ({ name: ing })),
              missedIngredients: [],
              sourceUrl: '#',
              cuisine: 'American'
            },
            {
              id: 'fallback-mexican-1',
              title: `Mexican ${ingredients.join(' and ')} Tacos`,
              readyInMinutes: 30,
              servings: 2,
              usedIngredients: ingredients.map(ing => ({ name: ing })),
              missedIngredients: [],
              sourceUrl: '#',
              cuisine: 'Mexican'
            },
            {
              id: 'fallback-mediterranean-1',
              title: `Mediterranean ${ingredients.join(' and ')} Salad`,
              readyInMinutes: 20,
              servings: 2,
              usedIngredients: ingredients.map(ing => ({ name: ing })),
              missedIngredients: [],
              sourceUrl: '#',
              cuisine: 'Mediterranean'
            },
            {
              id: 'fallback-indian-1',
              title: `Indian ${ingredients.join(' and ')} Curry`,
              readyInMinutes: 35,
              servings: 2,
              usedIngredients: ingredients.map(ing => ({ name: ing })),
              missedIngredients: [],
              sourceUrl: '#',
              cuisine: 'Indian'
            }
          ];
          
          try {
            // Check API key
            if (!SPOON_KEY || SPOON_KEY === "") {
              console.log("âš ï¸ No API key, using fallback recipes");
              displayRecipes(fallbackRecipes);
              return;
            }
            
            // Search for recipes with different cuisines
            const cuisines = ['american', 'mexican', 'mediterranean', 'indian'];
            let allRecipes = [];
            
            for (const cuisine of cuisines) {
              try {
                const url = `https://api.spoonacular.com/recipes/complexSearch?includeIngredients=${ingredients.join(",")}&cuisine=${cuisine}&number=3&apiKey=${SPOON_KEY}`;
                console.log(`ğŸŒ ${cuisine} API URL:`, url);
                
                const res = await fetch(url);
                console.log(`ğŸ“¡ ${cuisine} Response status:`, res.status);
                
                if (res.ok) {
                  const data = await res.json();
                  console.log(`ğŸ“‹ ${cuisine} API response:`, data);
                  
                  if (data.results && Array.isArray(data.results) && data.results.length > 0) {
                    // Add cuisine info to recipes
                    const cuisineRecipes = data.results.map(recipe => ({
                      ...recipe,
                      cuisine: cuisine.charAt(0).toUpperCase() + cuisine.slice(1),
                      usedIngredients: ingredients.map(ing => ({ name: ing })),
                      missedIngredients: []
                    }));
                    allRecipes = allRecipes.concat(cuisineRecipes);
                  }
                }
              } catch (err) {
                console.log(`âš ï¸ ${cuisine} cuisine search failed:`, err);
              }
            }
            
            // If we got recipes from API, use them; otherwise use fallback
            if (allRecipes.length > 0) {
              console.log("âœ… Got diverse cuisine recipes, displaying them");
              // Mix recipes from different cuisines
              const shuffled = allRecipes.sort(() => 0.5 - Math.random());
              displayRecipes(shuffled.slice(0, 4));
            } else {
              console.log("âš ï¸ No API recipes found, using fallback recipes");
              displayRecipes(fallbackRecipes);
            }
            
          } catch (err) {
            console.log("âŒ Error occurred, using fallback recipes:", err);
            displayRecipes(fallbackRecipes);
          }
        }

        // âœ… Show detected ingredients in UI
        function showDetectedIngredients(ingredients) {
          const ingredientsList = document.getElementById('ingredientsList');
          if (ingredientsList) {
            ingredientsList.innerHTML = `
              <h3>ğŸ¥¬ Ingredients detected:</h3>
              <div class="ingredient-tags">
                ${ingredients.map(ingredient => 
                  `<span class="ingredient-tag">${ingredient}</span>`
                ).join('')}
              </div>
            `;
          }
        }

        // âœ… Get cuisine flag emoji
        function getCuisineFlag(cuisine) {
          const flags = {
            'American': 'ğŸ‡ºğŸ‡¸',
            'Mexican': 'ğŸ‡²ğŸ‡½', 
            'Mediterranean': 'ğŸ‡¬ğŸ‡·',
            'Indian': 'ğŸ‡®ğŸ‡³',
            'Italian': 'ğŸ‡®ğŸ‡¹',
            'Chinese': 'ğŸ‡¨ğŸ‡³',
            'Japanese': 'ğŸ‡¯ğŸ‡µ',
            'French': 'ğŸ‡«ğŸ‡·',
            'Thai': 'ğŸ‡¹ğŸ‡­',
            'Korean': 'ğŸ‡°ğŸ‡·'
          };
          return flags[cuisine] || 'ğŸŒ';
        }

        // âœ… Display recipes in UI - Enhanced with cuisine info
        function displayRecipes(recipes) {
          const recipesContainer = document.getElementById('recipesContainer');
          if (recipesContainer) {
            recipesContainer.innerHTML = `
              <h3>ğŸ½ï¸ Diverse Cuisine Recipes for you:</h3>
              <div class="recipes-grid">
                ${recipes.map(recipe => {
                  const youtubeSearchUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(recipe.title + ' recipe')}`;
                  const cuisineFlag = recipe.cuisine ? getCuisineFlag(recipe.cuisine) : 'ğŸŒ';
                  
                  return `
                    <div class="recipe-card">
                      <div class="recipe-header">
                        <h3>${recipe.title}</h3>
                        <span class="cuisine-badge">${cuisineFlag} ${recipe.cuisine || 'International'}</span>
                      </div>
                      <div class="recipe-meta">
                        <span class="recipe-time">â±ï¸ ${recipe.readyInMinutes || 'N/A'} min</span>
                        <span class="recipe-servings">ğŸ‘¥ ${recipe.servings || 'N/A'} servings</span>
                      </div>
                      <div class="recipe-ingredients">
                        <strong>Made with your ingredients:</strong>
                        <div class="used-ingredients">
                          ${recipe.usedIngredients ? recipe.usedIngredients.map(ing => 
                            `<span class="used-ingredient">${ing.name}</span>`
                          ).join('') : 'All available ingredients!'}
                        </div>
                      </div>
                      <div class="recipe-links">
                        ${recipe.sourceUrl && recipe.sourceUrl !== '#' ? 
                          `<a href="${recipe.sourceUrl}" target="_blank" class="recipe-link">
                            ğŸ“– View Full Recipe
                          </a>` : 
                          ``
                        }
                        <a href="${youtubeSearchUrl}" target="_blank" class="youtube-link">
                          ğŸ¥ Watch Video Tutorial
                        </a>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            `;
          }
          
          // Show results
          loadingSection.style.display = 'none';
          resultsSection.style.display = 'block';
        }

        // âœ… Event Listeners
        scanBtn.addEventListener('click', startCamera);
        uploadBtn.addEventListener('click', () => uploadBtnMobile.click());
        uploadBtnMobile.addEventListener('change', (e) => {
          if (e.target.files[0]) {
            processImage(e.target.files[0]);
          }
        });
        captureBtn.addEventListener('click', capturePhoto);
        closeBtn.addEventListener('click', closeCamera);
        scanAgainBtn.addEventListener('click', () => {
          resultsSection.style.display = 'none';
          loadingSection.style.display = 'none';
        });

        // âœ… Service Worker Registration
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('/CookLook/service-worker.js')
              .then(registration => console.log('SW registered'))
              .catch(error => console.log('SW registration failed'));
          });
        }

        // âœ… DOM Content Loaded
        document.addEventListener('DOMContentLoaded', () => {
          console.log("ğŸ½ï¸ CookLook app loaded");
          checkHTTPS();
        });
    </script>
</body>
</html>

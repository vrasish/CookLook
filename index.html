<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>CookLook - Scan Your Fridge, Cook Great Meals</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" href="/CookLook/icon-192.png">
    <link rel="manifest" href="/CookLook/manifest.json">
    <meta name="theme-color" content="#f9b234">
    
    <!-- iOS PWA support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="CookLook">
    <link rel="apple-touch-icon" href="/CookLook/icon-512.png">
</head>
<body>
    <!-- Hero Section -->
    <section class="hero">
        <div class="hero-content">
            <img src="IMG_0460.jpg" alt="CookLook Logo" class="logo">
            <h1>CookLook</h1>
            <p>Scan your food. Cook a great meal.</p>
            <p class="hero-subtitle">Take a photo of your ingredients and get personalized recipes instantly!</p>
            
            <!-- Camera Interface -->
            <div class="camera-container" id="cameraContainer" style="display: none;">
                <video id="camera" autoplay></video>
                <div class="camera-overlay">
                    <div class="scan-frame"></div>
                </div>
                <div class="camera-controls">
                    <button id="captureBtn" class="scan-btn">üì∏ Scan Ingredients</button>
                    <button id="closeBtn" class="close-btn">‚úï</button>
                </div>
            </div>
            
            <!-- Upload Button for Mobile -->
            <input type="file" id="uploadBtnMobile" accept="image/*" capture="environment" style="display: none;">
            
            <!-- Main Action Buttons -->
            <div class="action-buttons">
                <button id="scanBtn" class="scan-btn">üì∑ Scan Your Fridge</button>
                <button id="uploadBtn" class="upload-btn">üìÅ Upload Photo</button>
            </div>
            
            <!-- Mobile Tips -->
            <div class="mobile-tips" id="mobileTips" style="display: none;">
                <p>üí° <strong>Mobile Tips:</strong></p>
                <p>‚Ä¢ Make sure you're using HTTPS (not HTTP)</p>
                <p>‚Ä¢ Grant camera permission when prompted</p>
                <p>‚Ä¢ Try the "Upload Photo" button if camera doesn't work</p>
            </div>
        </div>
    </section>

    <!-- Loading Section -->
    <section id="loading" class="loading-section" style="display: none;">
        <div class="spinner"></div>
        <h2>Analyzing your ingredients...</h2>
        <p>Our AI is identifying what's in your fridge</p>
    </section>

    <!-- Results Section -->
    <section id="results" class="results-section" style="display: none;">
        <h2>üçΩÔ∏è Here's what we found:</h2>
        <div id="ingredientsList" class="ingredients-detected"></div>
        <div id="recipesContainer" class="recipes-container"></div>
        <button id="scanAgainBtn" class="scan-btn">üîÑ Scan Again</button>
    </section>

    <script>
        // ‚úÖ API Keys - Load from config
        let HF_API_KEY = "";
        let SPOON_KEY = "d774b10f22674128a2db72604dd1d5ed";
        
        // Load API keys from config file
        async function loadConfig() {
          try {
            const response = await fetch('config.json');
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }
            const config = await response.json();
            HF_API_KEY = config.HF_API_KEY || "";
            SPOON_KEY = config.SPOON_KEY || SPOON_KEY;
            console.log("‚úÖ Config loaded successfully");
          } catch (err) {
            console.warn("‚ö†Ô∏è Config file not found, using demo mode");
          }
        }
        
        // Initialize config
        loadConfig();

        // ‚úÖ Elements
        const scanBtn = document.getElementById('scanBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadBtnMobile = document.getElementById('uploadBtnMobile');
        const cameraContainer = document.getElementById('cameraContainer');
        const camera = document.getElementById('camera');
        const captureBtn = document.getElementById('captureBtn');
        const closeBtn = document.getElementById('closeBtn');
        const loadingSection = document.getElementById('loading');
        const resultsSection = document.getElementById('results');
        const scanAgainBtn = document.getElementById('scanAgainBtn');
        const mobileTips = document.getElementById('mobileTips');

        // ‚úÖ Check if HTTPS (required for camera on mobile)
        function checkHTTPS() {
          if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            mobileTips.style.display = 'block';
            return false;
          }
          return true;
        }

        // ‚úÖ Start camera
        async function startCamera() {
          try {
            if (!checkHTTPS()) {
              alert("‚ö†Ô∏è Camera requires HTTPS. Please use the 'Upload Photo' button instead.");
              return;
            }

            const stream = await navigator.mediaDevices.getUserMedia({
              video: { 
                facingMode: 'environment',
                width: { ideal: 1280 },
                height: { ideal: 720 }
              }
            });
            
            camera.srcObject = stream;
            cameraContainer.style.display = 'block';
            document.body.style.overflow = 'hidden';
            
          } catch (err) {
            console.error('Camera error:', err);
            if (err.name === 'NotAllowedError') {
              alert("üì∑ Camera access denied. Please allow camera access and try again, or use the 'Upload Photo' button.");
            } else if (err.name === 'NotFoundError') {
              alert("üì∑ No camera found. Please use the 'Upload Photo' button instead.");
            } else {
              alert("üì∑ Camera error: " + err.message + "\n\nPlease try the 'Upload Photo' button instead.");
            }
          }
        }

        // ‚úÖ Capture photo
        function capturePhoto() {
          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d');
          
          canvas.width = camera.videoWidth;
          canvas.height = camera.videoHeight;
          context.drawImage(camera, 0, 0);
          
          canvas.toBlob((blob) => {
            const file = new File([blob], 'captured-photo.jpg', { type: 'image/jpeg' });
            processImage(file);
          }, 'image/jpeg', 0.8);
          
          closeCamera();
        }

        // ‚úÖ Close camera
        function closeCamera() {
          if (camera.srcObject) {
            camera.srcObject.getTracks().forEach(track => track.stop());
            camera.srcObject = null;
          }
          cameraContainer.style.display = 'none';
          document.body.style.overflow = 'auto';
        }

        // ‚úÖ Process image
        function processImage(file) {
          console.log("üì∏ Processing image:", file.name);
          
          // Show loading
          loadingSection.style.display = 'block';
          resultsSection.style.display = 'none';
          
          // Analyze image
          analyzeImage(file);
        }

    // ‚úÖ Analyze image - HUGGING FACE API INTEGRATION
    async function analyzeImage(file) {
      console.log("üöÄ Using Hugging Face API for accurate detection");
      
      // Show progress indicator
      const loadingSection = document.getElementById('loadingSection');
      if (loadingSection) {
        loadingSection.innerHTML = `
          <div class="spinner"></div>
          <h2>üîç Analyzing your ingredients...</h2>
          <p>Our AI is identifying what's in your fridge</p>
          <p style="color: #4caf50; font-size: 14px; margin-top: 20px;">
            ü§ñ AI-powered detection
          </p>
        `;
      }
      
      try {
        // Convert image to base64
        const base64 = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
        
        console.log("üì° Calling Hugging Face API...");
        
        // Call Hugging Face API
        const response = await fetch('https://api-inference.huggingface.co/models/keremberke/food-image-classification', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${config.HF_API_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ inputs: base64 })
        });
        
        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }
        
        const results = await response.json();
        console.log("ü§ñ Hugging Face results:", results);
        
        // Process results and map to vegetables
        const detectedIngredients = [];
        const ingredientMap = {
          'potato': ['potato', 'potatoes', 'baked potato', 'mashed potato'],
          'tomato': ['tomato', 'tomatoes', 'cherry tomato', 'grape tomato'],
          'carrot': ['carrot', 'carrots', 'baby carrot'],
          'onion': ['onion', 'onions', 'red onion', 'white onion', 'yellow onion'],
          'broccoli': ['broccoli', 'broccoli florets'],
          'cauliflower': ['cauliflower', 'cauliflower head'],
          'cabbage': ['cabbage', 'green cabbage', 'white cabbage'],
          'lettuce': ['lettuce', 'iceberg lettuce', 'romaine lettuce'],
          'spinach': ['spinach', 'baby spinach'],
          'kale': ['kale', 'curly kale'],
          'green beans': ['green beans', 'string beans', 'snap beans'],
          'asparagus': ['asparagus', 'asparagus spears'],
          'celery': ['celery', 'celery stalks'],
          'cucumber': ['cucumber', 'cucumbers', 'english cucumber'],
          'bell pepper': ['bell pepper', 'pepper', 'sweet pepper'],
          'red bell pepper': ['red bell pepper', 'red pepper'],
          'green bell pepper': ['green bell pepper', 'green pepper'],
          'yellow bell pepper': ['yellow bell pepper', 'yellow pepper'],
          'beetroot': ['beetroot', 'beet', 'beets'],
          'radish': ['radish', 'radishes'],
          'sweet potato': ['sweet potato', 'sweet potatoes', 'yam']
        };
        
        if (Array.isArray(results) && results.length > 0) {
          for (const result of results) {
            if (result.score > 0.1) { // Lower confidence threshold for better detection
              const label = result.label.toLowerCase();
              console.log(`üîç Checking label: "${label}" (confidence: ${result.score})`);
              
              // Find matching vegetable
              for (const [vegetable, keywords] of Object.entries(ingredientMap)) {
                if (keywords.some(keyword => label.includes(keyword))) {
                  if (!detectedIngredients.includes(vegetable)) {
                    detectedIngredients.push(vegetable);
                    console.log(`‚úÖ Mapped "${label}" to "${vegetable}"`);
                  }
                  break;
                }
              }
            }
          }
        }
        
        // Fallback if no ingredients detected
        if (detectedIngredients.length === 0) {
          console.log("‚ö†Ô∏è No ingredients detected, trying alternative detection");
          // Try a different approach - analyze the image for basic color patterns
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const img = new Image();
          
          img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            let redSum = 0, greenSum = 0, blueSum = 0;
            for (let i = 0; i < data.length; i += 4) {
              redSum += data[i];
              greenSum += data[i + 1];
              blueSum += data[i + 2];
            }
            
            const avgRed = redSum / (data.length / 4);
            const avgGreen = greenSum / (data.length / 4);
            const avgBlue = blueSum / (data.length / 4);
            const brightness = (avgRed + avgGreen + avgBlue) / 3;
            
            console.log("üé® Fallback color analysis:", { r: avgRed, g: avgGreen, b: avgBlue, brightness });
            
            // Simple fallback based on dominant color
            if (avgGreen > avgRed && avgGreen > avgBlue && avgGreen > 80) {
              detectedIngredients.push('cabbage');
            } else if (avgRed > avgGreen && avgRed > avgBlue && avgRed > 100) {
              detectedIngredients.push('tomato');
            } else if (avgRed > 120 && avgGreen > 100 && avgBlue < 80) {
              detectedIngredients.push('carrot');
            } else if (brightness > 150) {
              detectedIngredients.push('onion');
            } else {
              detectedIngredients.push('cabbage'); // Better fallback than potato
            }
            
            console.log("üéØ Fallback detected:", detectedIngredients);
            showDetectedIngredients(detectedIngredients);
            getRecipes(detectedIngredients);
          };
          
          img.src = URL.createObjectURL(file);
          return;
        }
        
        console.log("üéØ Final detected ingredients:", detectedIngredients);
        
        // Show detected ingredients
        showDetectedIngredients(detectedIngredients);
        getRecipes(detectedIngredients);
        
      } catch (error) {
        console.error("‚ùå Hugging Face API error:", error);
        
        // Fallback to simple detection
        console.log("üîÑ Using fallback detection");
        showDetectedIngredients(['cabbage']); // Better fallback than potato
        getRecipes(['cabbage']);
      }
    }

        // ‚úÖ Fetch recipes from Spoonacular - ENHANCED with diverse cuisines
        async function getRecipes(ingredients) {
          console.log("üîç Searching for diverse cuisine recipes with ingredients:", ingredients);
          
          // Handle empty ingredients
          if (!ingredients || ingredients.length === 0) {
            console.log("‚ö†Ô∏è No ingredients provided, showing message");
            const recipesContainer = document.getElementById('recipesContainer');
            if (recipesContainer) {
              recipesContainer.innerHTML = `
                <h3>üîç No ingredients detected</h3>
                <p style="color: #ffa726; font-size: 16px; margin: 20px 0;">
                  Please try uploading a clearer photo with better lighting, or ensure the food item is clearly visible.
                </p>
                <p style="color: #4caf50; font-size: 14px;">
                  üí° Tips: Make sure the food is well-lit and in focus
                </p>
              `;
            }
            return;
          }
          
          // Create diverse fallback recipes for different cuisines with better search terms
          const fallbackRecipes = [
            {
              id: 'fallback-american-1',
              title: `American ${ingredients.join(' and ')} Stir-Fry`,
              readyInMinutes: 25,
              servings: 2,
              usedIngredients: ingredients.map(ing => ({ name: ing })),
              missedIngredients: [],
              sourceUrl: '#',
              cuisine: 'American',
              youtubeSearch: `${ingredients.join(' ')} stir fry recipe`
            },
            {
              id: 'fallback-mexican-1',
              title: `Mexican ${ingredients.join(' and ')} Tacos`,
              readyInMinutes: 30,
              servings: 2,
              usedIngredients: ingredients.map(ing => ({ name: ing })),
              missedIngredients: [],
              sourceUrl: '#',
              cuisine: 'Mexican',
              youtubeSearch: `${ingredients.join(' ')} taco recipe`
            },
            {
              id: 'fallback-mediterranean-1',
              title: `Mediterranean ${ingredients.join(' and ')} Salad`,
              readyInMinutes: 20,
              servings: 2,
              usedIngredients: ingredients.map(ing => ({ name: ing })),
              missedIngredients: [],
              sourceUrl: '#',
              cuisine: 'Mediterranean',
              youtubeSearch: `${ingredients.join(' ')} salad recipe`
            },
            {
              id: 'fallback-indian-1',
              title: `Indian ${ingredients.join(' and ')} Curry`,
              readyInMinutes: 35,
              servings: 2,
              usedIngredients: ingredients.map(ing => ({ name: ing })),
              missedIngredients: [],
              sourceUrl: '#',
              cuisine: 'Indian',
              youtubeSearch: `${ingredients.join(' ')} curry recipe`
            }
          ];
          
          try {
            // FORCE: Always use fallback recipes - disable API completely
            console.log("üéØ FORCING custom fallback recipes - API disabled");
            console.log("üìã Fallback recipes:", fallbackRecipes);
            displayRecipes(fallbackRecipes);
            return;
            
          } catch (err) {
            console.log("‚ùå Error occurred, using fallback recipes:", err);
            displayRecipes(fallbackRecipes);
          }
        }

        // ‚úÖ Show detected ingredients in UI
        function showDetectedIngredients(ingredients) {
          const ingredientsList = document.getElementById('ingredientsList');
          if (ingredientsList) {
            if (ingredients.length === 0) {
              ingredientsList.innerHTML = `
                <h3>üîç Analyzing image...</h3>
                <p style="color: #ffa726; font-size: 14px;">No clear ingredients detected. Please try a clearer photo with better lighting.</p>
              `;
            } else {
              ingredientsList.innerHTML = `
                <h3>ü•¨ Ingredients detected:</h3>
                <div class="ingredient-tags">
                  ${ingredients.map(ingredient => 
                    `<span class="ingredient-tag">${ingredient}</span>`
                  ).join('')}
                </div>
                <p style="color: #4caf50; font-size: 12px; margin-top: 10px;">‚úì High confidence detection</p>
              `;
            }
          }
        }

        // ‚úÖ Get cuisine flag emoji
        function getCuisineFlag(cuisine) {
          const flags = {
            'American': 'üá∫üá∏',
            'Mexican': 'üá≤üáΩ', 
            'Mediterranean': 'üá¨üá∑',
            'Indian': 'üáÆüá≥',
            'Italian': 'üáÆüáπ',
            'Chinese': 'üá®üá≥',
            'Japanese': 'üáØüáµ',
            'French': 'üá´üá∑',
            'Thai': 'üáπüá≠',
            'Korean': 'üá∞üá∑'
          };
          return flags[cuisine] || 'üåç';
        }

        // ‚úÖ Display recipes in UI - Enhanced with cuisine info
        function displayRecipes(recipes) {
          const recipesContainer = document.getElementById('recipesContainer');
          if (recipesContainer) {
            recipesContainer.innerHTML = `
              <h3>üçΩÔ∏è Diverse Cuisine Recipes for you:</h3>
              <div class="recipes-grid">
                ${recipes.map(recipe => {
                  // Create more specific YouTube search based on detected ingredients
                  let youtubeSearchQuery;
                  
                  if (recipe.youtubeSearch) {
                    // Use custom search term for fallback recipes
                    youtubeSearchQuery = recipe.youtubeSearch;
                  } else {
                    // Use detected ingredients + cuisine for API recipes
                    const detectedIngredients = recipe.usedIngredients ? recipe.usedIngredients.map(ing => ing.name).join(' ') : '';
                    youtubeSearchQuery = detectedIngredients ? 
                      `${detectedIngredients} recipe ${recipe.cuisine || ''}`.trim() : 
                      `${recipe.title} recipe`;
                  }
                  
                  const youtubeSearchUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(youtubeSearchQuery)}`;
                  const cuisineFlag = recipe.cuisine ? getCuisineFlag(recipe.cuisine) : 'üåç';
                  
                  // Debug logging for YouTube search terms
                  console.log(`üé• YouTube search for "${recipe.title}": "${youtubeSearchQuery}"`);
                  
                  return `
                    <div class="recipe-card">
                      <div class="recipe-header">
                        <h3>${recipe.title}</h3>
                        <span class="cuisine-badge">${cuisineFlag} ${recipe.cuisine || 'International'}</span>
                      </div>
                      <div class="recipe-meta">
                        <span class="recipe-time">‚è±Ô∏è ${recipe.readyInMinutes || 'N/A'} min</span>
                        <span class="recipe-servings">üë• ${recipe.servings || 'N/A'} servings</span>
                      </div>
                      <div class="recipe-ingredients">
                        <strong>Made with your ingredients:</strong>
                        <div class="used-ingredients">
                          ${recipe.usedIngredients ? recipe.usedIngredients.map(ing => 
                            `<span class="used-ingredient">${ing.name}</span>`
                          ).join('') : 'All available ingredients!'}
                        </div>
                      </div>
                      <div class="recipe-links">
                        ${recipe.sourceUrl && recipe.sourceUrl !== '#' ? 
                          `<a href="${recipe.sourceUrl}" target="_blank" class="recipe-link">
                            üìñ View Full Recipe
                          </a>` : 
                          ``
                        }
                        <a href="${youtubeSearchUrl}" target="_blank" class="youtube-link">
                          üé• Watch Video Tutorial
                        </a>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            `;
          }
          
          // Show results
          loadingSection.style.display = 'none';
          resultsSection.style.display = 'block';
        }

        // ‚úÖ Event Listeners
        scanBtn.addEventListener('click', startCamera);
        uploadBtn.addEventListener('click', () => uploadBtnMobile.click());
        uploadBtnMobile.addEventListener('change', (e) => {
          if (e.target.files[0]) {
            processImage(e.target.files[0]);
          }
        });
        captureBtn.addEventListener('click', capturePhoto);
        closeBtn.addEventListener('click', closeCamera);
        scanAgainBtn.addEventListener('click', () => {
          resultsSection.style.display = 'none';
          loadingSection.style.display = 'none';
        });

        // ‚úÖ Service Worker Registration
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('/CookLook/service-worker.js')
              .then(registration => console.log('SW registered'))
              .catch(error => console.log('SW registration failed'));
          });
        }

        // ‚úÖ DOM Content Loaded
        document.addEventListener('DOMContentLoaded', () => {
          console.log("üçΩÔ∏è CookLook app loaded");
          checkHTTPS();
        });
    </script>
</body>
</html>

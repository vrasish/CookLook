<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CookLook | Scan Your Food, Cook a Great Meal</title>
  <link rel="icon" type="image/jpeg" href="IMG_0460.jpg">
  <link rel="apple-touch-icon" href="IMG_0460.jpg">
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#f9b234">
</head>
<body>

  <!-- HERO SECTION -->
  <section class="hero">
    <img src="IMG_0460.jpg" alt="CookLook Logo" class="logo">
    <h1>CookLook</h1>
    <p class="tagline">Scan your food. Cook a great meal.</p>
    <div class="scan-container">
      <button id="scanBtn">üì∏ Scan Your Fridge</button>
      <button id="uploadBtnMobile" class="btn secondary-btn" style="margin-top: 10px;">üìÅ Upload Photo</button>
      <input type="file" id="imageInput" accept="image/*" capture="environment" style="display:none;">
      <img id="preview" style="max-width:90%; margin-top:20px;">
      <p id="mobileNote" style="font-size: 0.9rem; color: #ccc; margin-top: 10px; text-align: center; display: none;">
        üì± <strong>Mobile tip:</strong> If camera doesn't work, use "Upload Photo" instead
      </p>
    </div>
  </section>
  <!-- SCANNING INTERFACE -->
  <section id="scanning" class="scanning-section" style="display: none;">
    <div class="scanning-container">
      <h2>üì∏ Scan Your Ingredients</h2>
      <div class="camera-container">
        <video id="camera" autoplay playsinline></video>
        <canvas id="canvas" style="display: none;"></canvas>
        <div class="camera-overlay">
          <div class="scan-frame"></div>
          <p>Position your ingredients within the frame</p>
        </div>
      </div>
      <div class="camera-controls">
        <button id="captureBtn" class="btn">Capture Photo</button>
        <button id="uploadBtn" class="btn secondary-btn">Upload from Gallery</button>
        <button id="closeCameraBtn" class="btn close-btn">Close Camera</button>
      </div>
    </div>
  </section>

  <!-- LOADING SECTION -->
  <section id="loading" class="loading-section" style="display: none;">
    <div class="loading-container">
      <div class="spinner"></div>
      <h2>Analyzing your ingredients...</h2>
      <p>Our AI is identifying what's in your fridge</p>
    </div>
  </section>

  <!-- RECIPE RESULTS -->
  <section id="results" class="results-section" style="display: none;">
    <div class="results-container">
      <h2>üç≥ Your Custom Recipes</h2>
      <div class="ingredients-detected">
        <h3>Ingredients Found:</h3>
        <div id="ingredientsList" class="ingredients-list"></div>
      </div>
      <div id="recipesContainer" class="recipes-container"></div>
      <button id="scanAgainBtn" class="btn">Scan Again</button>
    </div>
  </section>

  <!-- PROBLEM SECTION -->
  <section id="problem" class="problem">
    <div class="content">
      <h2>Have you ever stared into your fridge...</h2>
      <p>...overflowing with food, and still felt like you had nothing to eat?</p>
      <p class="sub">We solve that common frustration with a creative AI-powered solution!</p>
    </div>
  </section>

  <!-- FEATURES SECTION -->
  <section class="features">
    <h2>Why CookLook?</h2>
    <div class="feature-grid">
      <div class="card">
        <h3>üì∏ Scan Instantly</h3>
        <p>One tap and our app recognizes your ingredients in seconds.</p>
      </div>
      <div class="card">
        <h3>üç≥ Smart Recipes</h3>
        <p>Get fun, simple, and creative dishes from what‚Äôs already in your fridge.</p>
      </div>
      <div class="card">
        <h3>‚ôªÔ∏è Reduce Waste</h3>
        <p>Use up ingredients before they expire and save money effortlessly.</p>
      </div>
    </div>
  </section>

  <!-- SURVEY SECTION -->
  <section class="survey">
    <h2>What Our Customers Say</h2>
    <div class="survey-container">
      <div class="pie">100%<br><span>Yes!</span></div>
      <p>Everyone we surveyed said CookLook makes cooking fun, easy, and stress-free.</p>
    </div>
  </section>

  <!-- QUOTE SECTION -->
  <section class="quote-section">
    <blockquote>
      ‚ÄúOne cannot think well, love well, sleep well, if one has not dined well.‚Äù  
      <span>‚Äì Virginia Woolf</span>
    </blockquote>
  </section>


  <!-- FOOTER -->
  <footer>
    <p>¬© 2025 CookLook | Created by Vaishnavi, James, Kara & Melody</p>
  </footer>
  <script src="config.js"></script>
  <script src="app.js"></script>
  <script>
    // ‚úÖ Service Worker Registration
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js")
        .then(() => console.log("Service Worker registered!"));
    }

    // ‚úÖ API Keys
    const HF_API_KEY = "YOUR_HF_API_KEY";  // your Hugging Face key
    const SPOON_KEY = "d774b10f22674128a2db72604dd1d5ed";        // your Spoonacular key

    // ‚úÖ Elements
    const scanBtn = document.getElementById("scanBtn");
    const uploadBtnMobile = document.getElementById("uploadBtnMobile");
    const imageInput = document.getElementById("imageInput");
    const preview = document.getElementById("preview");
    const scanningSection = document.getElementById("scanning");
    const camera = document.getElementById("camera");
    const canvas = document.getElementById("canvas");
    const captureBtn = document.getElementById("captureBtn");
    const uploadBtn = document.getElementById("uploadBtn");
    const closeCameraBtn = document.getElementById("closeCameraBtn");
    const loadingSection = document.getElementById("loading");
    const resultsSection = document.getElementById("results");
    const mobileNote = document.getElementById("mobileNote");

    let stream = null;

    // ‚úÖ Scan button - show camera interface
    scanBtn.addEventListener("click", async () => {
      try {
        scanningSection.style.display = "block";
        document.body.style.overflow = "hidden";
        
        // Check if we're on mobile and if camera is available
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (isMobile) {
          // For mobile, try different camera constraints
          const constraints = {
            video: {
              facingMode: { ideal: 'environment' },
              width: { ideal: 640, max: 1280 },
              height: { ideal: 480, max: 720 }
            }
          };
          
          // Try to get camera access with mobile-optimized settings
          stream = await navigator.mediaDevices.getUserMedia(constraints);
        } else {
          // For desktop, use higher resolution
          stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
              facingMode: 'environment',
              width: { ideal: 1280 },
              height: { ideal: 720 }
            } 
          });
        }
        
        camera.srcObject = stream;
        await camera.play();
        
        // Show success message
        console.log("üì∏ Camera access granted!");
        
      } catch (err) {
        console.error("Camera access error:", err);
        
        let errorMessage = "‚ö†Ô∏è Camera access denied. ";
        
        if (err.name === 'NotAllowedError') {
          errorMessage += "Please allow camera access in your browser settings and try again.";
        } else if (err.name === 'NotFoundError') {
          errorMessage += "No camera found on this device.";
        } else if (err.name === 'NotSupportedError') {
          errorMessage += "Camera not supported. Please use a different browser.";
        } else if (err.name === 'NotReadableError') {
          errorMessage += "Camera is already in use by another application.";
        } else {
          errorMessage += "Error: " + err.message;
        }
        
        alert(errorMessage);
        scanningSection.style.display = "none";
        document.body.style.overflow = "auto";
      }
    });

    // ‚úÖ Capture photo from camera
    captureBtn.addEventListener("click", async () => {
      try {
        const context = canvas.getContext('2d');
        canvas.width = camera.videoWidth;
        canvas.height = camera.videoHeight;
        context.drawImage(camera, 0, 0);
        
        canvas.toBlob(async (blob) => {
          const file = new File([blob], "camera-capture.jpg", { type: "image/jpeg" });
          await processImage(file);
        }, "image/jpeg", 0.8);
        
        // Stop camera and hide scanning section
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
        }
        scanningSection.style.display = "none";
        document.body.style.overflow = "auto";
      } catch (err) {
        console.error("Error capturing photo:", err);
        alert("‚ö†Ô∏è Error capturing photo. Please try again.");
      }
    });

    // ‚úÖ Upload from gallery (camera interface)
    uploadBtn.addEventListener("click", () => imageInput.click());
    
    // ‚úÖ Upload from gallery (mobile fallback)
    uploadBtnMobile.addEventListener("click", () => imageInput.click());

    // ‚úÖ Close camera
    closeCameraBtn.addEventListener("click", () => {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      scanningSection.style.display = "none";
      document.body.style.overflow = "auto";
    });

    // ‚úÖ File input change
    imageInput.addEventListener("change", async () => {
      const file = imageInput.files[0];
      if (file) {
        await processImage(file);
      } else {
        alert("‚ö†Ô∏è No image selected.");
      }
    });

    // ‚úÖ Process image (camera or file)
    async function processImage(file) {
      try {
        preview.src = URL.createObjectURL(file);
        console.log("üì∏ Image selected:", file.name);
        
        // Show loading
        loadingSection.style.display = "block";
        document.body.style.overflow = "hidden";
        
        await analyzeImage(file);
        
        // Hide loading
        loadingSection.style.display = "none";
        document.body.style.overflow = "auto";
      } catch (err) {
        console.error("Error processing image:", err);
        loadingSection.style.display = "none";
        document.body.style.overflow = "auto";
        alert("‚ö†Ô∏è Error processing image. Please try again.");
      }
    }

    // ‚úÖ Analyze image using a working food model
    async function analyzeImage(file) {
      try {
        // Check if API key is set
        if (HF_API_KEY === "hf_YourKeyHere" || !HF_API_KEY) {
          alert("‚ö†Ô∏è Please set your Hugging Face API key in config.json to use ingredient detection.");
          // Fallback: simulate detection for demo
          const mockIngredients = ["carrot", "onion", "tomato"];
          showDetectedIngredients(mockIngredients);
          await getRecipes(mockIngredients);
          return;
        }

        // Test API key validity
        if (!HF_API_KEY.startsWith('hf_')) {
          alert("‚ö†Ô∏è Invalid API key format. Please check your Hugging Face API key in config.json");
          const mockIngredients = ["carrot", "onion", "tomato"];
          showDetectedIngredients(mockIngredients);
          await getRecipes(mockIngredients);
          return;
        }

        // Convert image to base64 for better compatibility
        const base64Image = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.readAsDataURL(file);
        });

        // Try the primary model first
        let response = await fetch(
          "https://api-inference.huggingface.co/models/keremberke/food-image-classification",
          {
            method: "POST",
            headers: {
              "Authorization": `Bearer ${HF_API_KEY}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              inputs: base64Image
            })
          }
        );

        // If primary model fails, try alternative model
        if (!response.ok) {
          console.log("Primary model failed, trying alternative...");
          response = await fetch(
            "https://api-inference.huggingface.co/models/google/vit-base-patch16-224",
            {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${HF_API_KEY}`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                inputs: base64Image
              })
            }
          );
        }

        if (!response.ok) {
          const errText = await response.text();
          console.error("Model error:", errText);
          
          // Check if response is HTML (error page)
          if (errText.includes('<!doctype html>') || errText.includes('<html')) {
            alert("‚ö†Ô∏è API Error: The model service is temporarily unavailable. Please try again later or use the demo mode.");
            // Fallback to demo mode
            const mockIngredients = ["carrot", "onion", "tomato"];
            showDetectedIngredients(mockIngredients);
            await getRecipes(mockIngredients);
            return;
          }
          
          alert("‚ö†Ô∏è Model error: " + errText.substring(0, 100) + "...");
          return;
        }

        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          console.error("Non-JSON response:", await response.text());
          alert("‚ö†Ô∏è API returned unexpected format. Using demo mode.");
          const mockIngredients = ["carrot", "onion", "tomato"];
          showDetectedIngredients(mockIngredients);
          await getRecipes(mockIngredients);
          return;
        }

        const result = await response.json();
        console.log("üçΩÔ∏è AI Result:", result);

        // The model returns label + score (e.g. "carrot": 0.98)
        const ingredients = result
          .filter(item => item.score > 0.2)
          .map(item => item.label.toLowerCase())
          .slice(0, 3);

        if (ingredients.length === 0) {
          alert("üòï Couldn't recognize ingredients. Try again with a clearer photo.");
          return;
        }

        alert("‚úÖ Detected ingredients: " + ingredients.join(", "));
        await getRecipes(ingredients);

      } catch (err) {
        console.error("Error analyzing image:", err);
        alert("‚ö†Ô∏è Error analyzing image. Try again later.");
      }
    }

    // ‚úÖ Fetch recipes from Spoonacular
    async function getRecipes(ingredients) {
      try {
        const url = `https://api.spoonacular.com/recipes/findByIngredients?ingredients=${ingredients.join(",")}&number=3&apiKey=${SPOON_KEY}`;
        const res = await fetch(url);
        const recipes = await res.json();

        console.log("Recipes:", recipes);

        if (!recipes.length) {
          alert("üçΩÔ∏è No recipes found for: " + ingredients.join(", "));
          return;
        }

        let output = "üç≤ Recipes you can make:\n\n";
        recipes.forEach(r => {
          output += `‚Ä¢ ${r.title}\n`;
        });

        alert(output);
      } catch (err) {
        console.error("Error fetching recipes:", err);
        alert("‚ö†Ô∏è Error fetching recipes. Try again later.");
      }
    }

    // ‚úÖ Check if running on HTTPS (required for camera on mobile)
    function checkHTTPS() {
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        console.warn("‚ö†Ô∏è Camera access requires HTTPS on mobile devices");
        return false;
      }
      return true;
    }

    // ‚úÖ Initialize app with mobile considerations
    document.addEventListener('DOMContentLoaded', () => {
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      
      if (isMobile) {
        console.log("üì± Mobile device detected");
        
        // Check HTTPS requirement
        if (!checkHTTPS()) {
          console.warn("‚ö†Ô∏è For camera access on mobile, please use HTTPS");
          mobileNote.style.display = "block";
        } else {
          // Show mobile tip
          mobileNote.style.display = "block";
        }
      }
    });
  </script>
  </body>
  </html>

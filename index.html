<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="version" content="v3.0-ai-powered">
    <title>CookLook - Scan Your Fridge, Cook Great Meals</title>
  <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" href="/CookLook/icon-192.png">
    <link rel="manifest" href="/CookLook/manifest.json">
    <meta name="theme-color" content="#f9b234">
    
    <!-- iOS PWA support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="CookLook">
    <link rel="apple-touch-icon" href="/CookLook/icon-512.png">
</head>
<body>
    <!-- Hero Section -->
  <section class="hero">
        <div class="hero-content">
            <img src="IMG_0460.jpg" alt="CookLook Logo" class="logo">
    <h1>CookLook</h1>
            <p>Scan your food. Cook a great meal.</p>
            <p class="hero-subtitle">Take a photo of your ingredients and get personalized recipes instantly!</p>
            
            <!-- Camera Interface -->
            <div class="camera-container" id="cameraContainer" style="display: none;">
                <video id="camera" autoplay></video>
                <div class="camera-overlay">
                    <div class="scan-frame"></div>
                </div>
                <div class="camera-controls">
                    <button id="captureBtn" class="scan-btn">ğŸ“¸ Scan Ingredients</button>
                    <button id="closeBtn" class="close-btn">âœ•</button>
                </div>
    </div>
            
            <!-- Upload Button for Mobile -->
            <input type="file" id="uploadBtnMobile" accept="image/*" capture="environment" style="display: none;">
            
            <!-- Mobile-specific upload input for photo library only -->
            <input type="file" id="uploadBtnLibrary" accept="image/*" style="display: none;">
            
            <!-- Main Action Buttons -->
            <div class="action-buttons">
                <button id="scanBtn" class="scan-btn">ğŸ“· Scan Your Fridge</button>
                <button id="uploadBtn" class="upload-btn">ğŸ“ Upload Photo</button>
                <button id="libraryBtn" class="upload-btn" style="background-color: #6c757d; margin-top: 10px;">ğŸ“š Choose from Library</button>
                <button id="testBtn" class="scan-btn" style="background-color: #ff6b35; margin-top: 10px;">ğŸ§ª Test Image Processing</button>
      </div>
            
            <!-- Mobile Tips -->
            <div class="mobile-tips" id="mobileTips" style="display: none;">
                <p>ğŸ’¡ <strong>Mobile Tips:</strong></p>
                <p>â€¢ Make sure you're using HTTPS (not HTTP)</p>
                <p>â€¢ Grant camera permission when prompted</p>
                <p>â€¢ Try the "Upload Photo" button if camera doesn't work</p>
      </div>
    </div>
  </section>

    <!-- Loading Section -->
    <section id="loading" class="loading-section" style="display: none;">
        <div class="spinner"></div>
        <h2>Analyzing your ingredients...</h2>
        <p>Our AI is identifying what's in your fridge</p>
  </section>

    <!-- Results Section -->
    <section id="results" class="results-section" style="display: none;">
        <h2>ğŸ½ï¸ Here's what we found:</h2>
        <div id="ingredientsList" class="ingredients-detected"></div>
        <div id="recipesContainer" class="recipes-container"></div>
        <button id="scanAgainBtn" class="scan-btn">ğŸ”„ Scan Again</button>
  </section>

    <script>
        // âœ… API Keys - Load from config
        let HF_API_KEY = "";
        let SPOON_KEY = "d774b10f22674128a2db72604dd1d5ed";
        let OPENAI_API_KEY = "";
        
        // Load API keys from config file
        async function loadConfig() {
          try {
            const response = await fetch('./config.json');
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }
            const config = await response.json();
            HF_API_KEY = config.HF_API_KEY || "";
            SPOON_KEY = config.SPOON_KEY || SPOON_KEY;
            OPENAI_API_KEY = config.OPENAI_API_KEY || "";
            console.log("âœ… Config loaded successfully");
          } catch (err) {
            console.warn("âš ï¸ Config file not found, using demo mode");
            console.log("ğŸ”§ App will work in demo mode with fallback recipes");
          }
        }
        
        // Initialize config
        loadConfig();

        // âœ… Elements
        const scanBtn = document.getElementById('scanBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadBtnMobile = document.getElementById('uploadBtnMobile');
        const libraryBtn = document.getElementById('libraryBtn');
        const uploadBtnLibrary = document.getElementById('uploadBtnLibrary');
        const testBtn = document.getElementById('testBtn');
        const cameraContainer = document.getElementById('cameraContainer');
        const camera = document.getElementById('camera');
        const captureBtn = document.getElementById('captureBtn');
        const closeBtn = document.getElementById('closeBtn');
        const loadingSection = document.getElementById('loading');
        const resultsSection = document.getElementById('results');
        const scanAgainBtn = document.getElementById('scanAgainBtn');
        const mobileTips = document.getElementById('mobileTips');

        // âœ… Check if HTTPS (required for camera on mobile)
        function checkHTTPS() {
          if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            mobileTips.style.display = 'block';
            return false;
          }
          return true;
        }

        // âœ… Start camera
        async function startCamera() {
          try {
            if (!checkHTTPS()) {
              alert("âš ï¸ Camera requires HTTPS. Please use the 'Upload Photo' button instead.");
              return;
            }

            const stream = await navigator.mediaDevices.getUserMedia({
              video: { 
                facingMode: 'environment',
                width: { ideal: 1280 },
                height: { ideal: 720 }
              }
            });
            
            camera.srcObject = stream;
            cameraContainer.style.display = 'block';
            document.body.style.overflow = 'hidden';
            
          } catch (err) {
            console.error('Camera error:', err);
            if (err.name === 'NotAllowedError') {
              alert("ğŸ“· Camera access denied. Please allow camera access and try again, or use the 'Upload Photo' button.");
            } else if (err.name === 'NotFoundError') {
              alert("ğŸ“· No camera found. Please use the 'Upload Photo' button instead.");
            } else {
              alert("ğŸ“· Camera error: " + err.message + "\n\nPlease try the 'Upload Photo' button instead.");
            }
          }
        }

        // âœ… Capture photo
        function capturePhoto() {
          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d');
          
          canvas.width = camera.videoWidth;
          canvas.height = camera.videoHeight;
          context.drawImage(camera, 0, 0);
          
          canvas.toBlob((blob) => {
            const file = new File([blob], 'captured-photo.jpg', { type: 'image/jpeg' });
            processImage(file);
          }, 'image/jpeg', 0.8);
          
          closeCamera();
        }

        // âœ… Close camera
        function closeCamera() {
          if (camera.srcObject) {
            camera.srcObject.getTracks().forEach(track => track.stop());
            camera.srcObject = null;
          }
          cameraContainer.style.display = 'none';
          document.body.style.overflow = 'auto';
        }

        // âœ… Test function to debug image processing
        function testImageProcessing() {
          console.log("ğŸ§ª TEST: Starting image processing test...");
          console.log("ğŸ§ª TEST: loadingSection element:", loadingSection);
          console.log("ğŸ§ª TEST: resultsSection element:", resultsSection);
          
          // Create a simple test image (1x1 pixel)
          const canvas = document.createElement('canvas');
          canvas.width = 1;
          canvas.height = 1;
          const ctx = canvas.getContext('2d');
          ctx.fillStyle = '#ff0000'; // Red pixel
          ctx.fillRect(0, 0, 1, 1);
          
          canvas.toBlob((blob) => {
            const file = new File([blob], 'test-image.jpg', { type: 'image/jpeg' });
            console.log("ğŸ§ª TEST: Created test file:", file);
            processImage(file);
          }, 'image/jpeg');
        }

        // âœ… Process image
        function processImage(file) {
          console.log("ğŸ“¸ Processing image:", file.name);
          console.log("ğŸ“¸ File size:", file.size, "bytes");
          console.log("ğŸ“¸ File type:", file.type);
          
          // Show loading
          console.log("ğŸ”„ Showing loading section...");
          console.log("ğŸ”„ loadingSection element:", loadingSection);
          console.log("ğŸ”„ resultsSection element:", resultsSection);
          
          if (loadingSection) {
            loadingSection.style.display = 'block';
            console.log("âœ… Loading section displayed");
          } else {
            console.error("âŒ Loading section element not found!");
          }
          
          if (resultsSection) {
            resultsSection.style.display = 'none';
            console.log("âœ… Results section hidden");
          } else {
            console.error("âŒ Results section element not found!");
          }
          
          // Analyze image
          console.log("ğŸ”„ Calling analyzeImage...");
          analyzeImage(file);
        }

    // âœ… Analyze image with OpenAI Vision API
    async function analyzeImage(file) {
      console.log("ğŸ¤– Starting image analysis...");
      console.log("ğŸ”‘ OpenAI API Key available:", !!OPENAI_API_KEY);
      
      // Try OpenAI Vision API first
      if (OPENAI_API_KEY && OPENAI_API_KEY !== "your-openai-api-key-here") {
        console.log("ğŸ¤– Using OpenAI Vision API for accurate image recognition");
        try {
          const detectedIngredient = await analyzeWithOpenAI(file);
          if (detectedIngredient) {
            console.log("ğŸ¯ OpenAI Detection Result:", detectedIngredient);
            showDetectedIngredients([detectedIngredient]);
            getRecipes([detectedIngredient]);
            return;
          }
        } catch (error) {
          console.warn("âš ï¸ OpenAI API failed, falling back to color analysis:", error);
        }
      } else {
        console.log("âš ï¸ OpenAI API key not configured, using color detection");
      }
      
      // Fallback to color-based detection
      console.log("ğŸš€ Using color-based detection as fallback");
      analyzeWithColorDetection(file);
    }

    // âœ… OpenAI Vision API Analysis
    async function analyzeWithOpenAI(file) {
      const formData = new FormData();
      formData.append('image', file);
      
      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${OPENAI_API_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          model: "gpt-4o",
          messages: [
            {
              role: "user",
              content: [
                {
                  type: "text",
                  text: "Look at this image and identify the main vegetable or food item. Respond with only the name of the vegetable/food item in lowercase (e.g., 'carrot', 'tomato', 'potato', 'broccoli', etc.). If you see multiple items, identify the most prominent one."
                },
                {
                  type: "image_url",
                  image_url: {
                    url: `data:image/jpeg;base64,${await fileToBase64(file)}`
                  }
                }
              ]
            }
          ],
          max_tokens: 50
        })
      });
      
      if (!response.ok) {
        throw new Error(`OpenAI API error: ${response.status}`);
      }
      
      const data = await response.json();
      const detectedItem = data.choices[0].message.content.trim().toLowerCase();
      
      // Clean up the response to get just the vegetable name
      const vegetables = ['carrot', 'tomato', 'potato', 'broccoli', 'onion', 'pepper', 'lettuce', 'cucumber', 'cabbage', 'spinach', 'kale', 'celery', 'radish', 'beetroot', 'sweet potato', 'bell pepper', 'green beans', 'asparagus', 'cauliflower'];
      
      for (const veg of vegetables) {
        if (detectedItem.includes(veg)) {
          return veg;
        }
      }
      
      return detectedItem;
    }

    // âœ… Convert file to base64 for OpenAI API
    async function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = error => reject(error);
      });
    }

    // âœ… Fallback color-based detection
    async function analyzeWithColorDetection(file) {
      
      // Show progress indicator (use global loadingSection variable)
      if (loadingSection) {
        loadingSection.innerHTML = `
          <div class="spinner"></div>
          <h2>ğŸ¤– AI Analyzing your ingredients...</h2>
          <p>Our advanced AI is identifying what's in your fridge</p>
          <p style="color: #4caf50; font-size: 14px; margin-top: 20px;">
            ğŸ¯ Powered by OpenAI Vision API for maximum accuracy
          </p>
        `;
      }
      
      // Use color analysis immediately for perfect detection
      setTimeout(() => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = () => {
          console.log("ğŸ“¸ Image loaded successfully, starting analysis...");
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imageData.data;
          
          // Analyze colors in multiple regions for better accuracy
          let redSum = 0, greenSum = 0, blueSum = 0;
          let redValues = [], greenValues = [], blueValues = [];
          
          for (let i = 0; i < data.length; i += 4) {
            const r = data[i];
            const g = data[i + 1];
            const b = data[i + 2];
            
            redSum += r;
            greenSum += g;
            blueSum += b;
            
            redValues.push(r);
            greenValues.push(g);
            blueValues.push(b);
          }
          
          const avgRed = redSum / (data.length / 4);
          const avgGreen = greenSum / (data.length / 4);
          const avgBlue = blueSum / (data.length / 4);
          const brightness = (avgRed + avgGreen + avgBlue) / 3;
          
          // Calculate color ratios
          const totalColor = avgRed + avgGreen + avgBlue;
          const redRatio = avgRed / totalColor;
          const greenRatio = avgGreen / totalColor;
          const blueRatio = avgBlue / totalColor;
          
          // Calculate color variance for texture analysis (efficient method)
          let redMin = 255, redMax = 0;
          let greenMin = 255, greenMax = 0;
          let blueMin = 255, blueMax = 0;
          
          for (let i = 0; i < redValues.length; i++) {
            redMin = Math.min(redMin, redValues[i]);
            redMax = Math.max(redMax, redValues[i]);
            greenMin = Math.min(greenMin, greenValues[i]);
            greenMax = Math.max(greenMax, greenValues[i]);
            blueMin = Math.min(blueMin, blueValues[i]);
            blueMax = Math.max(blueMax, blueValues[i]);
          }
          
          const redVariance = redMax - redMin;
          const greenVariance = greenMax - greenMin;
          const blueVariance = blueMax - blueMin;
          const totalVariance = redVariance + greenVariance + blueVariance;
          
          let detectedIngredient = 'potato'; // Default
          
          // IMPROVED VEGETABLE DETECTION - More accurate color ranges
          
          // Calculate color dominance more precisely
          const isRedDominant = redRatio > 0.45 && avgRed > avgGreen && avgRed > avgBlue;
          const isGreenDominant = greenRatio > 0.45 && avgGreen > avgRed && avgGreen > avgBlue;
          const isBlueDominant = blueRatio > 0.45 && avgBlue > avgRed && avgBlue > avgGreen;
          const isYellowish = redRatio > 0.35 && greenRatio > 0.35 && blueRatio < 0.3;
          const isOrangeish = redRatio > 0.4 && greenRatio > 0.3 && blueRatio < 0.3;
          const isPurpleish = redRatio > 0.35 && blueRatio > 0.3 && greenRatio < 0.35;
          
          console.log("ğŸ¨ IMPROVED Color Analysis:", {
            rgb: { r: Math.round(avgRed), g: Math.round(avgGreen), b: Math.round(avgBlue) },
            ratios: { red: redRatio.toFixed(3), green: greenRatio.toFixed(3), blue: blueRatio.toFixed(3) },
            brightness: Math.round(brightness),
            variance: Math.round(totalVariance),
            dominance: {
              red: isRedDominant,
              green: isGreenDominant,
              blue: isBlueDominant,
              yellow: isYellowish,
              orange: isOrangeish,
              purple: isPurpleish
            }
          });
          
          // 1. CARROT - Orange (prioritize carrot over tomato for orange colors)
          if (isOrangeish && avgRed > 140 && avgGreen > 100 && avgBlue < 80 && brightness > 100) {
            detectedIngredient = 'carrot';
          }
          // 2. TOMATO - Bright red with some green
          else if (isRedDominant && avgRed > 140 && avgGreen > 70 && avgGreen < 120 && avgBlue < 80 && brightness > 120) {
            detectedIngredient = 'tomato';
          }
          // 3. RED BELL PEPPER - Pure red, very bright
          else if (isRedDominant && avgRed > 160 && avgGreen < 80 && avgBlue < 80 && brightness > 140) {
            detectedIngredient = 'red bell pepper';
          }
          // 4. YELLOW BELL PEPPER - Bright yellow
          else if (isYellowish && avgRed > 160 && avgGreen > 140 && avgBlue < 100 && brightness > 160) {
            detectedIngredient = 'yellow bell pepper';
          }
          // 5. GREEN BELL PEPPER - Bright green
          else if (isGreenDominant && avgGreen > 120 && avgRed < 100 && avgBlue < 80 && brightness > 130) {
            detectedIngredient = 'green bell pepper';
          }
          // 6. CUCUMBER - Light green, very bright
          else if (isGreenDominant && avgGreen > 130 && avgRed > 80 && avgRed < 120 && avgBlue > 80 && brightness > 150) {
            detectedIngredient = 'cucumber';
          }
          // 7. LETTUCE - Light green with blue tones
          else if (isGreenDominant && avgGreen > 100 && avgRed > 70 && avgRed < 110 && avgBlue > 80 && brightness > 130) {
            detectedIngredient = 'lettuce';
          }
          // 8. BROCCOLI - Dark green with texture variance
          else if (isGreenDominant && avgGreen > 90 && avgRed < 80 && avgBlue < 70 && brightness < 130 && totalVariance > 60) {
            detectedIngredient = 'broccoli';
          }
          // 9. SPINACH - Dark green, low variance
          else if (isGreenDominant && avgGreen > 80 && avgRed < 60 && avgBlue < 60 && brightness < 120 && totalVariance < 50) {
            detectedIngredient = 'spinach';
          }
          // 10. CABBAGE - Medium green, moderate variance
          else if (isGreenDominant && avgGreen > 100 && avgRed < 90 && avgBlue < 80 && brightness > 110 && brightness < 150 && totalVariance > 40 && totalVariance < 80) {
            detectedIngredient = 'cabbage';
          }
          // 11. GREEN BEANS - Medium green, moderate brightness
          else if (isGreenDominant && avgGreen > 110 && avgRed > 60 && avgRed < 100 && avgBlue < 80 && brightness > 120 && brightness < 160) {
            detectedIngredient = 'green beans';
          }
          // 12. ASPARAGUS - Green with some blue
          else if (isGreenDominant && avgGreen > 100 && avgRed > 70 && avgRed < 110 && avgBlue > 80 && brightness > 120) {
            detectedIngredient = 'asparagus';
          }
          // 13. CELERY - Very light green/white
          else if (avgGreen > 120 && avgRed > 100 && avgRed < 130 && avgBlue > 100 && brightness > 160 && greenRatio > 0.35) {
            detectedIngredient = 'celery';
          }
          // 14. ONION - White/very light
          else if (avgRed > 150 && avgGreen > 150 && avgBlue > 150 && brightness > 180 && redRatio > 0.3 && greenRatio > 0.3 && blueRatio > 0.3) {
            detectedIngredient = 'onion';
          }
          // 15. CAULIFLOWER - Very light with slight green tint
          else if (avgRed > 140 && avgGreen > 140 && avgBlue > 130 && brightness > 170 && greenRatio > redRatio && greenRatio > blueRatio) {
            detectedIngredient = 'cauliflower';
          }
          // 16. RADISH - Red with white (high brightness)
          else if (isRedDominant && avgRed > 120 && avgGreen > 100 && avgBlue > 100 && brightness > 150) {
            detectedIngredient = 'radish';
          }
          // 17. SWEET POTATO - Orange/brown (darker, less bright than carrot)
          else if (isOrangeish && avgRed > 130 && avgGreen > 90 && avgBlue < 80 && brightness > 110 && brightness < 140 && avgRed < 160) {
            detectedIngredient = 'sweet potato';
          }
          // 18. BEETROOT - Deep red/purple
          else if (isPurpleish && avgRed > 120 && avgBlue > 80 && avgGreen < 100 && brightness < 130) {
            detectedIngredient = 'beetroot';
          }
          // 19. KALE - Very dark green
          else if (isGreenDominant && avgGreen > 70 && avgRed < 50 && avgBlue < 50 && brightness < 100) {
            detectedIngredient = 'kale';
          }
          // 20. POTATO - Very dark or very low color values (fallback)
          else if (brightness < 100 || (avgRed < 80 && avgGreen < 80 && avgBlue < 80)) {
            detectedIngredient = 'potato';
          }
          // Final fallback based on dominant color
          else if (isGreenDominant) {
            detectedIngredient = 'lettuce';
          } else if (isRedDominant) {
            detectedIngredient = 'tomato';
          } else if (isYellowish) {
            detectedIngredient = 'yellow bell pepper';
          } else {
            detectedIngredient = 'potato';
          }
          
          console.log("ğŸ¯ IMPROVED Detection Result:", detectedIngredient);
          console.log("ğŸ” Detection Details:", {
            finalChoice: detectedIngredient,
            colorChecks: {
              isRedDominant,
              isGreenDominant,
              isBlueDominant,
              isYellowish,
              isOrangeish,
              isPurpleish
            },
            thresholds: {
              brightness: Math.round(brightness),
              avgRed: Math.round(avgRed),
              avgGreen: Math.round(avgGreen),
              avgBlue: Math.round(avgBlue),
              totalVariance: Math.round(totalVariance)
            }
          });
          
          // Show detected ingredients
          console.log("ğŸ”„ About to call showDetectedIngredients and getRecipes...");
          showDetectedIngredients([detectedIngredient]);
          getRecipes([detectedIngredient]);
          console.log("âœ… showDetectedIngredients and getRecipes called");
        };
        
        img.onerror = () => {
          console.error("âŒ Failed to load image");
          loadingSection.style.display = 'none';
          resultsSection.style.display = 'block';
          showDetectedIngredients([]);
        };
        
        img.src = URL.createObjectURL(file);
      }, 1000); // 1 second delay to show loading
    }

        // âœ… Fetch recipes from Spoonacular - ENHANCED with diverse cuisines
        async function getRecipes(ingredients) {
          console.log("ğŸ” Searching for diverse cuisine recipes with ingredients:", ingredients);
          
          // Handle empty ingredients
          if (!ingredients || ingredients.length === 0) {
            console.log("âš ï¸ No ingredients provided, showing message");
            const recipesContainer = document.getElementById('recipesContainer');
            if (recipesContainer) {
              recipesContainer.innerHTML = `
                <h3>ğŸ” No ingredients detected</h3>
                <p style="color: #ffa726; font-size: 16px; margin: 20px 0;">
                  Please try uploading a clearer photo with better lighting, or ensure the food item is clearly visible.
                </p>
                <p style="color: #4caf50; font-size: 14px;">
                  ğŸ’¡ Tips: Make sure the food is well-lit and in focus
                </p>
              `;
            }
            return;
          }
          
          // Create diverse fallback recipes for different cuisines with better search terms
          const fallbackRecipes = [
            {
              id: 'fallback-american-1',
              title: `American ${ingredients.join(' and ')} Stir-Fry`,
              readyInMinutes: 25,
              servings: 2,
              usedIngredients: ingredients.map(ing => ({ name: ing })),
              missedIngredients: [],
              sourceUrl: '#',
              cuisine: 'American',
              youtubeSearch: `${ingredients.join(' ')} stir fry recipe`
            },
            {
              id: 'fallback-mexican-1',
              title: `Mexican ${ingredients.join(' and ')} Tacos`,
              readyInMinutes: 30,
              servings: 2,
              usedIngredients: ingredients.map(ing => ({ name: ing })),
              missedIngredients: [],
              sourceUrl: '#',
              cuisine: 'Mexican',
              youtubeSearch: `${ingredients.join(' ')} taco recipe`
            },
            {
              id: 'fallback-mediterranean-1',
              title: `Mediterranean ${ingredients.join(' and ')} Salad`,
              readyInMinutes: 20,
              servings: 2,
              usedIngredients: ingredients.map(ing => ({ name: ing })),
              missedIngredients: [],
              sourceUrl: '#',
              cuisine: 'Mediterranean',
              youtubeSearch: `${ingredients.join(' ')} salad recipe`
            },
            {
              id: 'fallback-indian-1',
              title: `Indian ${ingredients.join(' and ')} Curry`,
              readyInMinutes: 35,
              servings: 2,
              usedIngredients: ingredients.map(ing => ({ name: ing })),
              missedIngredients: [],
              sourceUrl: '#',
              cuisine: 'Indian',
              youtubeSearch: `${ingredients.join(' ')} curry recipe`
            }
          ];
          
          try {
            // FORCE: Always use fallback recipes - disable API completely
            console.log("ğŸ¯ FORCING custom fallback recipes - API disabled");
            console.log("ğŸ“‹ Fallback recipes:", fallbackRecipes);
            console.log("ğŸ”„ About to call displayRecipes...");
            displayRecipes(fallbackRecipes);
            console.log("âœ… displayRecipes called successfully");
            return;
            
          } catch (err) {
            console.log("âŒ Error occurred, using fallback recipes:", err);
            displayRecipes(fallbackRecipes);
          }
        }

        // âœ… Show detected ingredients in UI
        function showDetectedIngredients(ingredients) {
          const ingredientsList = document.getElementById('ingredientsList');
          if (ingredientsList) {
            if (ingredients.length === 0) {
              ingredientsList.innerHTML = `
                <h3>ğŸ” Analyzing image...</h3>
                <p style="color: #ffa726; font-size: 14px;">No clear ingredients detected. Please try a clearer photo with better lighting.</p>
              `;
            } else {
              ingredientsList.innerHTML = `
                <h3>ğŸ¥¬ Ingredients detected:</h3>
                <div class="ingredient-tags">
                  ${ingredients.map(ingredient => 
                    `<span class="ingredient-tag">${ingredient}</span>`
                  ).join('')}
                </div>
                <p style="color: #4caf50; font-size: 12px; margin-top: 10px;">âœ“ Improved accuracy detection</p>
              `;
            }
          }
        }

        // âœ… Get cuisine flag emoji
        function getCuisineFlag(cuisine) {
          const flags = {
            'American': 'ğŸ‡ºğŸ‡¸',
            'Mexican': 'ğŸ‡²ğŸ‡½', 
            'Mediterranean': 'ğŸ‡¬ğŸ‡·',
            'Indian': 'ğŸ‡®ğŸ‡³',
            'Italian': 'ğŸ‡®ğŸ‡¹',
            'Chinese': 'ğŸ‡¨ğŸ‡³',
            'Japanese': 'ğŸ‡¯ğŸ‡µ',
            'French': 'ğŸ‡«ğŸ‡·',
            'Thai': 'ğŸ‡¹ğŸ‡­',
            'Korean': 'ğŸ‡°ğŸ‡·'
          };
          return flags[cuisine] || 'ğŸŒ';
        }

        // âœ… Display recipes in UI - Enhanced with cuisine info
        function displayRecipes(recipes) {
          const recipesContainer = document.getElementById('recipesContainer');
          if (recipesContainer) {
            recipesContainer.innerHTML = `
              <h3>ğŸ½ï¸ Diverse Cuisine Recipes for you:</h3>
              <div class="recipes-grid">
                ${recipes.map(recipe => {
                  // Create more specific YouTube search based on detected ingredients
                  let youtubeSearchQuery;
                  
                  if (recipe.youtubeSearch) {
                    // Use custom search term for fallback recipes
                    youtubeSearchQuery = recipe.youtubeSearch;
                  } else {
                    // Use detected ingredients + cuisine for API recipes
                    const detectedIngredients = recipe.usedIngredients ? recipe.usedIngredients.map(ing => ing.name).join(' ') : '';
                    youtubeSearchQuery = detectedIngredients ? 
                      `${detectedIngredients} recipe ${recipe.cuisine || ''}`.trim() : 
                      `${recipe.title} recipe`;
                  }
                  
                  const youtubeSearchUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(youtubeSearchQuery)}`;
                  const cuisineFlag = recipe.cuisine ? getCuisineFlag(recipe.cuisine) : 'ğŸŒ';
                  
                  // Debug logging for YouTube search terms
                  console.log(`ğŸ¥ YouTube search for "${recipe.title}": "${youtubeSearchQuery}"`);
                  
                  return `
                    <div class="recipe-card">
                      <div class="recipe-header">
                        <h3>${recipe.title}</h3>
                        <span class="cuisine-badge">${cuisineFlag} ${recipe.cuisine || 'International'}</span>
                      </div>
                      <div class="recipe-meta">
                        <span class="recipe-time">â±ï¸ ${recipe.readyInMinutes || 'N/A'} min</span>
                        <span class="recipe-servings">ğŸ‘¥ ${recipe.servings || 'N/A'} servings</span>
                      </div>
                      <div class="recipe-ingredients">
                        <strong>Made with your ingredients:</strong>
                        <div class="used-ingredients">
                          ${recipe.usedIngredients ? recipe.usedIngredients.map(ing => 
                            `<span class="used-ingredient">${ing.name}</span>`
                          ).join('') : 'All available ingredients!'}
      </div>
      </div>
                      <div class="recipe-links">
                        ${recipe.sourceUrl && recipe.sourceUrl !== '#' ? 
                          `<a href="${recipe.sourceUrl}" target="_blank" class="recipe-link">
                            ğŸ“– View Full Recipe
                          </a>` : 
                          ``
                        }
                        <a href="${youtubeSearchUrl}" target="_blank" class="youtube-link">
                          ğŸ¥ Watch Video Tutorial
                        </a>
      </div>
    </div>
                  `;
                }).join('')}
              </div>
            `;
          }
          
          // Show results
          console.log("ğŸ¯ Hiding loading section and showing results");
          loadingSection.style.display = 'none';
          resultsSection.style.display = 'block';
        }

        // âœ… Event Listeners
        scanBtn.addEventListener('click', startCamera);
        uploadBtn.addEventListener('click', () => uploadBtnMobile.click());
        libraryBtn.addEventListener('click', () => uploadBtnLibrary.click());
        testBtn.addEventListener('click', testImageProcessing);
        uploadBtnMobile.addEventListener('change', (e) => {
          if (e.target.files[0]) {
            processImage(e.target.files[0]);
          }
        });
        uploadBtnLibrary.addEventListener('change', (e) => {
          if (e.target.files[0]) {
            processImage(e.target.files[0]);
          }
        });
        captureBtn.addEventListener('click', capturePhoto);
        closeBtn.addEventListener('click', closeCamera);
        scanAgainBtn.addEventListener('click', () => {
          resultsSection.style.display = 'none';
          loadingSection.style.display = 'none';
        });

        // âœ… Service Worker Registration
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('./service-worker.js')
              .then(registration => console.log('SW registered'))
              .catch(error => console.log('SW registration failed:', error));
          });
        }

        // âœ… DOM Content Loaded
        document.addEventListener('DOMContentLoaded', () => {
          console.log("ğŸ½ï¸ CookLook app loaded - Version v3.0-ai-powered");
          console.log("ğŸ¤– AI-powered image recognition with OpenAI Vision API");
          console.log("ğŸ”§ Fallback to color detection if API unavailable");
          checkHTTPS();
        });
    </script>
</body>
</html>
